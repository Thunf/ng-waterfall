!function(t,a){"use strict";return"function"==typeof define&&define.amd?void define(["angular"],function(t){return a(t)}):a(t)}(angular||null,function(t){"use strict";var a=t.module("ngWaterfall",[]);return a.factory("$safeApply",function(){return function(t,a){var e=t.$root.$$phase;"$apply"==e||"$digest"==e?a&&"function"==typeof a&&a():t.$apply(a)}}),a.factory("NgWaterfallParams",["$q",function(a){var e=function(e,n){this.data=[],this.setParams=function(a){return t.isDefined(a)?(r=t.extend(r,a),this):r},this.setSettings=function(a){return t.isDefined(a)?(s=t.extend(s,a),this):s},this.getData=function(a,e){return a.resolve(t.isArray(this.data)&&t.isObject(e)?this.data:[]),a.promise},this.loadNewData=function(){var t=a.defer(),e=this,n=null;if(s.scope)return s.loading=!0,n=s.getData(t,this),n||(n=t.promise),n.then(function(t){return s.loading=!1,e.data=t,s.scope&&(s.scope.$data=t),t})};var r=this.$params={name:"waterfall",containerId:"ng-waterfall",extendOutboxClass:"outbox",extendBoxClass:"box",contentTemplate:void 0,cols:void 0,colsWidth:200},s={scope:null,loading:!1};return this.setSettings(n),this.setParams(e),this};return e}]),a.factory("ngWaterfallParams",["NgWaterfallParams",function(t){return t}]),a.controller("ngWaterfallController",["$scope","ngWaterfallParams","$window","$document","$element","$attrs","$compile","$safeApply",function(a,e,n,r,s,o,i,l){var c=!0;a.hasOwnProperty("params")||(a.params=new e,a.params.isNullInstance=!0,a.ngData={},a.total=0),a.params.setSettings().scope=a,a.$watch("params.$params",function(t,e){t!==e&&(a.params.setSettings().scope=a,a.params.loadNewData().then(function(t){m(t)}),a.params.isNullInstance||(c=!1))},!0),t.element(n).bind("scroll",function(){if(r[0].activeElement.scrollHeight-n.scrollY-n.innerHeight<200){if(a.params.setSettings().loading)return;a.params.loadNewData().then(function(t){m(t)})}}),a.imgLoad=function(t,e){a.total++,f(a.params.$params.containerId,a.params.$params.cols)};var f=this.toWaterfall=function(e,n){var r=t.element("#"+e),s=r.find(".outbox"),o=null;if(o=t.isDefined(n)&&t.isNumber(n)?n:Math.floor(r[0].offsetWidth/s[0].offsetWidth),r.css({position:"relative",left:"50%",width:o*s[0].offsetWidth,"margin-left":-(o*s[0].offsetWidth>>>1),background:"transparent"}),(a.Harr&&a.Harr.length||[])<a.params.$params.cols){for(var i=a.Harr=[],l=0;o>l&&s[l];l++)i.push(s[l].offsetHeight);{a.minkey=0,a.minH=i[0]}}if(a.total>o){var c=a.total-1;c<s.length&&(t.forEach(a.Harr,function(t,e){a.minH>t&&(a.minH=t,a.minkey=e)}),t.element(s[c]).css({position:"absolute",top:a.Harr[a.minkey],left:s[a.minkey].offsetLeft}),a.minH+=s[c].offsetHeight,a.Harr[a.minkey]+=s[c].offsetHeight)}},m=(this.compileNewBox=function(t){s.attr("ng-waterfall")&&s.addClass("ng-waterfall clearfix").attr({id:a.params.$params.containerId})},this.compileEachBox=function(e){s.attr("ng-waterfall")&&(s.addClass("ng-waterfall clearfix").attr("id",a.params.$params.containerId),a.templates={content:a.params.$params.contentTemplate?a.params.$params.contentTemplate:"ng-waterfall/box/content.html"},t.forEach(e,function(e){var n=t.element(document.createElement("img")).attr({src:e.src||"",alt:e.alt||"",title:e.title||""});n.on("load",function(){a.total++,f(a.params.$params.containerId,a.params.$params.cols)});var r=t.element(document.createElement("div")).addClass("content").attr({"ng-include":"templates.content"}),o=t.element(document.createElement("div")).addClass("box "+a.params.$params.extendBoxClass.toString());o.append(n,r);var c=t.element(document.createElement("div")).css({width:a.params.$params.colsWidth}).addClass("outbox "+a.params.$params.extendOutboxClass.toString());c.append(o),s.append(c),l(a,function(){i(c)(a)})}))})}]),a.directive("ngWaterfall",function(){return{restrict:"A",scope:!1,controller:"ngWaterfallController",compile:function(t,a){return{pre:function(t,a,e,n){},post:function(t,a,e,n){t.$watch(e.ngWaterfall,function(a){t.params=a},!1)}}}}}),a.run(["$templateCache",function(t){t.put("ng-waterfall/box/content.html","<p>我就是自由的示例</p><p>1</p>")}]),a});